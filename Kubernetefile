pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE = 'ranimaj/spring-app'  // Remplacez par votre nom
        KUBE_NAMESPACE = 'devops'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'master', 
                    url: 'https://github.com/Ranimaj/Project_Devops.git'
            }
        }
        
        stage('Setup Maven') {
            steps {
                script {
                    // V√©rifier si Maven est install√©, sinon l'installer
                    sh '''
                        if ! command -v mvn &> /dev/null; then
                            echo "Maven n'est pas install√©, installation..."
                            sudo apt update
                            sudo apt install -y maven
                        fi
                        mvn --version
                    '''
                }
            }
        }
        
        stage('Build Maven') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    // V√©rifier Dockerfile
                    sh 'cat Dockerfile || echo "Pas de Dockerfile, cr√©ation d\'un simple..."'
                    
                    // Cr√©er un Dockerfile simple si n√©cessaire
                    sh '''
                        if [ ! -f Dockerfile ]; then
                            cat > Dockerfile << EOF
                        FROM openjdk:11-jre-slim
                        COPY target/*.jar app.jar
                        ENTRYPOINT ["java", "-jar", "/app.jar"]
                        EXPOSE 8080
                        EOF
                        fi
                    '''
                    
                    docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                }
            }
        }
        
        stage('Push Docker Image') {
            steps {
                script {
                    // Seulement si vous avez un compte Docker Hub
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            docker login -u $DOCKER_USER -p $DOCKER_PASS
                            docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    sh """
                        echo "D√©ploiement sur Kubernetes..."
                        
                        # V√©rifier l'acc√®s √† Kubernetes
                        kubectl get nodes
                        kubectl get pods -n ${KUBE_NAMESPACE} || echo "Namespace ${KUBE_NAMESPACE} non trouv√©"
                        
                        # Mettre √† jour l'image dans le d√©ploiement
                        kubectl set image deployment/spring-app \
                            spring-app=${DOCKER_IMAGE}:${BUILD_NUMBER} \
                            -n ${KUBE_NAMESPACE} \
                            --record
                        
                        # Attendre le d√©ploiement
                        kubectl rollout status deployment/spring-app -n ${KUBE_NAMESPACE}
                        
                        echo "‚úÖ D√©ploiement termin√©"
                    """
                }
            }
        }
        
        stage('Test Deployment') {
            steps {
                script {
                    sh '''
                        # Attendre que l'application soit pr√™te
                        sleep 20
                        
                        # Obtenir l'URL du service
                        URL=$(minikube service spring-service --url -n devops 2>/dev/null || echo "")
                        
                        if [ -n "$URL" ]; then
                            echo "Testing application at: $URL"
                            curl -f $URL && echo "‚úÖ Application test passed!" || echo "‚ö†Ô∏è Application test warning"
                        else
                            echo "‚ö†Ô∏è Impossible d'obtenir l'URL du service"
                            # Tester directement avec l'IP de minikube
                            MINIKUBE_IP=$(minikube ip)
                            curl -f http://$MINIKUBE_IP:30093/ || echo "Test alternatif √©chou√©"
                        fi
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo 'üöÄ Pipeline r√©ussi! Application d√©ploy√©e dans Kubernetes.'
            slackSend(color: 'good', message: "Pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER} r√©ussi!")
        }
        failure {
            echo '‚ùå Pipeline √©chou√©. V√©rifiez les logs.'
            slackSend(color: 'danger', message: "Pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER} √©chou√©!")
        }
    }
}
